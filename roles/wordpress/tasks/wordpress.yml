- apt:
    name:
      - apache2
      - php
      - php-mysql
      - php-curl
      - php-xml
      - php-gd
      - mariadb-client
      - unzip
      - curl
    update_cache: yes

- file:
    path: "{{ wordpress_install_path }}"
    state: directory
    owner: www-data
    group: www-data
    mode: '0755'

- get_url:
    url: https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
    dest: /usr/local/bin/wp
    mode: '0755'

- shell: wp core download --allow-root --path={{ wordpress_install_path }}
  args:
    creates: "{{ wordpress_install_path }}/wp-config-sample.php"

- shell: >
    wp config create
    --dbname={{ wordpress_db_name }}
    --dbuser={{ wordpress_db_user }}
    --dbpass={{ hostvars['localhost'].wordpress_db_password }}
    --dbhost=192.168.27.158
    --path={{ wordpress_install_path }}
    --allow-root
  args:
    creates: "{{ wordpress_install_path }}/wp-config.php"

- shell: |
    wp core install \
      --url="{{ wordpress_site_url }}" \
      --title="Mon Site WordPress" \
      --admin_user=admin \
      --admin_password=admin123 \
      --admin_email=admin@example.com \
      --path={{ wordpress_install_path }} \
      --allow-root
  args:
    creates: "{{ wordpress_install_path }}/.installed"
  become: true


- file:
    path: "{{ wordpress_install_path }}"
    state: directory
    recurse: yes
    owner: www-data
    group: www-data

- service:
    name: apache2
    state: restarted